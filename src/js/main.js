/**
 * YOLO Grid Demo - Ana Uygulama Kontrolc√ºs√º
 * 
 * Bu mod√ºl t√ºm uygulamanƒ±n ana kontrollerini y√∂netir:
 * - Uygulama ba≈ülatma
 * - Mod√ºller arasƒ± koordinasyon
 * - Event handling
 * - State management
 */

// Import mod√ºlleri - Railway path fix
import { GridManager } from './grid-manager.js';
import { CameraHandler } from './camera-handler.js';
import { YOLOSimulation } from './yolo-simulation.js';
import { UIComponents } from './ui-components.js';

class YOLOGridApp {
    constructor() {
        this.isInitialized = false;
        this.isRunning = false;
        
        // Ana mod√ºller
        this.gridManager = null;
        this.cameraHandler = null;
        this.yoloSimulation = null;
        this.uiComponents = null;
        
        // Uygulama state
        this.state = {
            gridSize: 13,
            showConfidence: true,
            tutorialMode: false,
            currentStep: 0,
            detections: [],
            performance: {
                fps: 0,
                processTime: 0,
                lastUpdate: Date.now()
            }
        };
        
        // DOM elementleri
        this.elements = {};
        
        // Event listeners
        this.eventListeners = new Map();
        
        console.log('üéØ YOLO Grid Demo - Uygulama Ba≈ülatƒ±lƒ±yor...');
    }
    
    /**
     * Uygulamayƒ± ba≈ülatƒ±r
     */
    async init() {
        try {
            console.log('üì¶ Mod√ºller y√ºkleniyor...');
            
            // DOM elementlerini yakala
            this.cacheDOMElements();
            
            // Mod√ºlleri initialize et
            await this.initializeModules();
            
            // Event listener'larƒ± baƒüla
            this.bindEventListeners();
            
            // UI'ƒ± g√ºncelle
            this.updateUI();
            
            // Grid preview'ƒ±nƒ± ba≈ülat
            this.startGridPreview();
            
            this.isInitialized = true;
            console.log('‚úÖ Uygulama ba≈üarƒ±yla ba≈ülatƒ±ldƒ±!');
            
            // Welcome animasyonu
            this.showWelcomeAnimation();
            
        } catch (error) {
            console.error('‚ùå Uygulama ba≈ülatƒ±lƒ±rken hata:', error);
            this.showError('Uygulama ba≈ülatƒ±lƒ±rken bir hata olu≈ütu.');
        }
    }
    
    /**
     * DOM elementlerini cache'ler
     */
    cacheDOMElements() {
        this.elements = {
            // Buttons
            startCamera: document.getElementById('startCamera'),
            stopCamera: document.getElementById('stopCamera'),
            tutorialMode: document.getElementById('tutorialMode'),
            
            // Controls
            gridSize: document.getElementById('gridSize'),
            showConfidence: document.getElementById('showConfidence'),
            
            // Video section
            webcam: document.getElementById('webcam'),
            gridOverlay: document.getElementById('gridOverlay'),
            detectionOverlay: document.getElementById('detectionOverlay'),
            cameraStatus: document.getElementById('cameraStatus'),
            
            // Info panel
            stepContainer: document.getElementById('stepContainer'),
            detectionResults: document.getElementById('detectionResults'),
            resultsList: document.getElementById('resultsList'),
            gridStats: document.getElementById('gridStats'),
            currentGridSize: document.getElementById('currentGridSize'),
            
            // Statistics
            activeCells: document.getElementById('activeCells'),
            totalCells: document.getElementById('totalCells'),
            detectionCount: document.getElementById('detectionCount'),
            
            // Tutorial
            tutorialSection: document.getElementById('tutorialSection'),
            tutorialSteps: document.getElementById('tutorialSteps'),
            prevStep: document.getElementById('prevStep'),
            nextStep: document.getElementById('nextStep'),
            stepIndicator: document.getElementById('stepIndicator'),
            
            // Grid preview
            gridPreview: document.getElementById('gridPreview')
        };
        
        // Eksik elementleri kontrol et
        const missingElements = Object.entries(this.elements)
            .filter(([key, element]) => !element)
            .map(([key]) => key);
            
        if (missingElements.length > 0) {
            console.warn('‚ö†Ô∏è Eksik DOM elementleri:', missingElements);
        }
    }
    
    /**
     * Mod√ºlleri initialize eder
     */
    async initializeModules() {
        // Grid Manager
        this.gridManager = new GridManager({
            gridSize: this.state.gridSize,
            overlayCanvas: this.elements.gridOverlay,
            showConfidence: this.state.showConfidence
        });
        
        // Camera Handler  
        this.cameraHandler = new CameraHandler({
            videoElement: this.elements.webcam,
            onFrame: this.handleVideoFrame.bind(this),
            onStatusChange: this.handleCameraStatusChange.bind(this)
        });
        
        // YOLO Simulation
        this.yoloSimulation = new YOLOSimulation({
            onDetection: this.handleDetection.bind(this),
            onProcessingUpdate: this.handleProcessingUpdate.bind(this)
        });
        
        // UI Components
        this.uiComponents = new UIComponents({
            elements: this.elements,
            onStateChange: this.handleUIStateChange.bind(this)
        });
        
        console.log('‚úÖ T√ºm mod√ºller y√ºklendi');
    }
    
    /**
     * Event listener'larƒ± baƒülar
     */
    bindEventListeners() {
        // Camera controls
        this.addEventListeners([
            [this.elements.startCamera, 'click', this.startCamera.bind(this)],
            [this.elements.stopCamera, 'click', this.stopCamera.bind(this)],
            
            // Grid controls
            [this.elements.gridSize, 'change', this.handleGridSizeChange.bind(this)],
            [this.elements.showConfidence, 'change', this.handleConfidenceToggle.bind(this)],
            
            // Tutorial controls
            [this.elements.tutorialMode, 'click', this.toggleTutorialMode.bind(this)],
            [this.elements.prevStep, 'click', this.previousTutorialStep.bind(this)],
            [this.elements.nextStep, 'click', this.nextTutorialStep.bind(this)],
            
            // Window events
            [window, 'resize', this.handleWindowResize.bind(this)],
            [window, 'beforeunload', this.cleanup.bind(this)]
        ]);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', this.handleKeyboard.bind(this));
        
        console.log('üîó Event listener\'lar baƒülandƒ±');
    }
    
    /**
     * Event listener helper
     */
    addEventListeners(listeners) {
        listeners.forEach(([element, event, handler]) => {
            if (element) {
                element.addEventListener(event, handler);
                this.eventListeners.set(`${element.id || 'window'}-${event}`, {
                    element, event, handler
                });
            }
        });
    }
    
    /**
     * Grid preview animasyonunu ba≈ülatƒ±r
     */
    startGridPreview() {
        if (!this.elements.gridPreview) return;
        
        // 5x5 grid olu≈ütur
        const gridSize = 5;
        this.elements.gridPreview.innerHTML = '';
        
        for (let i = 0; i < gridSize * gridSize; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-preview-cell';
            cell.textContent = i + 1;
            
            // Random highlight animasyonu
            setTimeout(() => {
                if (Math.random() < 0.3) {
                    cell.classList.add('grid-preview-cell--highlight');
                }
            }, i * 100);
            
            this.elements.gridPreview.appendChild(cell);
        }
    }
    
    /**
     * Kamerayƒ± ba≈ülatƒ±r
     */
    async startCamera() {
        try {
            this.showLoading('Kamera ba≈ülatƒ±lƒ±yor...');
            
            await this.cameraHandler.start();
            this.isRunning = true;
            
            // Grid'i ba≈ülat
            this.gridManager.start();
            
            // YOLO sim√ºlasyonunu ba≈ülat
            this.yoloSimulation.start();
            
            this.updateCameraControls(true);
            this.hideLoading();
            
            console.log('üìπ Kamera ba≈ülatƒ±ldƒ±');
            
        } catch (error) {
            console.error('‚ùå Kamera ba≈ülatƒ±lƒ±rken hata:', error);
            this.showError('Kamera eri≈üimi saƒülanamadƒ±. L√ºtfen kamera izinlerini kontrol edin.');
            this.hideLoading();
        }
    }
    
    /**
     * Kamerayƒ± durdurur
     */
    async stopCamera() {
        try {
            this.cameraHandler.stop();
            this.gridManager.stop();
            this.yoloSimulation.stop();
            
            this.isRunning = false;
            this.updateCameraControls(false);
            
            // Sonu√ßlarƒ± temizle
            this.clearDetections();
            
            console.log('‚èπÔ∏è Kamera durduruldu');
            
        } catch (error) {
            console.error('‚ùå Kamera durdurulurken hata:', error);
        }
    }
    
    /**
     * Video frame'i i≈üler
     */
    handleVideoFrame(frameData) {
        if (!this.isRunning) return;
        
        // Performance tracking
        const startTime = performance.now();
        
        // Grid'i g√ºncelle
        this.gridManager.updateFrame(frameData);
        
        // YOLO sim√ºlasyonu √ßalƒ±≈ütƒ±r
        this.yoloSimulation.processFrame(frameData);
        
        // Performance metrics g√ºncelle
        const processTime = performance.now() - startTime;
        this.updatePerformanceMetrics(processTime);
    }
    
    /**
     * Kamera durumu deƒüi≈üikliƒüini i≈üler
     */
    handleCameraStatusChange(status) {
        const statusElement = this.elements.cameraStatus;
        if (!statusElement) return;
        
        const statusDot = statusElement.querySelector('.status-dot');
        
        switch (status) {
            case 'connecting':
                statusElement.textContent = 'Kamera Baƒülanƒ±yor...';
                statusElement.className = 'status connecting';
                break;
                
            case 'active':
                statusElement.innerHTML = '<span class="status-dot"></span>Kamera Aktif';
                statusElement.className = 'status active';
                break;
                
            case 'error':
                statusElement.innerHTML = '<span class="status-dot"></span>Kamera Hatasƒ±';
                statusElement.className = 'status error';
                break;
                
            case 'stopped':
                statusElement.innerHTML = '<span class="status-dot"></span>Kamera Durduruldu';
                statusElement.className = 'status';
                break;
        }
    }
    
    /**
     * Nesne tespitini i≈üler
     */
    handleDetection(detections) {
        this.state.detections = detections;
        
        // Grid'e detection'larƒ± g√∂nder
        this.gridManager.updateDetections(detections);
        
        // UI'ƒ± g√ºncelle
        this.updateDetectionResults(detections);
        this.updateGridStatistics();
    }
    
    /**
     * ƒ∞≈ülem g√ºncellemesini i≈üler
     */
    handleProcessingUpdate(processingData) {
        // Grid processing indicator'ƒ± g√ºncelle
        this.gridManager.updateProcessingIndicator(processingData.isProcessing);
        
        // Performance metrics g√ºncelle
        if (processingData.metrics) {
            this.updatePerformanceMetrics(processingData.metrics.processTime);
        }
    }
    
    /**
     * Grid boyutu deƒüi≈üikliƒüini i≈üler
     */
    handleGridSizeChange(event) {
        const newSize = parseInt(event.target.value);
        this.state.gridSize = newSize;
        
        // Grid'i g√ºncelle
        this.gridManager.setGridSize(newSize);
        
        // UI'ƒ± g√ºncelle
        this.updateGridInfo();
        
        console.log(`üìè Grid boyutu deƒüi≈ütirildi: ${newSize}x${newSize}`);
    }
    
    /**
     * Confidence g√∂sterim toggle'ƒ±nƒ± i≈üler
     */
    handleConfidenceToggle(event) {
        this.state.showConfidence = event.target.checked;
        this.gridManager.setShowConfidence(this.state.showConfidence);
        
        console.log(`üìä Confidence skorlarƒ±: ${this.state.showConfidence ? 'a√ßƒ±k' : 'kapalƒ±'}`);
    }
    
    /**
     * UI state deƒüi≈üikliƒüini i≈üler
     */
    handleUIStateChange(stateChange) {
        Object.assign(this.state, stateChange);
        this.updateUI();
    }
    
    /**
     * Keyboard shortcut'larƒ± i≈üler
     */
    handleKeyboard(event) {
        if (event.ctrlKey || event.metaKey) {
            switch (event.key) {
                case ' ':
                    event.preventDefault();
                    if (this.isRunning) {
                        this.stopCamera();
                    } else {
                        this.startCamera();
                    }
                    break;
                    
                case 't':
                    event.preventDefault();
                    this.toggleTutorialMode();
                    break;
                    
                case '1':
                case '2':
                case '3':
                    event.preventDefault();
                    const gridSizes = [7, 13, 19];
                    const index = parseInt(event.key) - 1;
                    if (gridSizes[index]) {
                        this.elements.gridSize.value = gridSizes[index];
                        this.handleGridSizeChange({target: {value: gridSizes[index]}});
                    }
                    break;
            }
        }
    }
    
    /**
     * Window resize'ƒ± i≈üler
     */
    handleWindowResize() {
        // Grid'i yeniden boyutlandƒ±r
        if (this.gridManager) {
            this.gridManager.resize();
        }
        
        // Camera'yƒ± yeniden ayarla
        if (this.cameraHandler && this.isRunning) {
            this.cameraHandler.resize();
        }
    }
    
    /**
     * Tutorial modunu toggle eder
     */
    toggleTutorialMode() {
        this.state.tutorialMode = !this.state.tutorialMode;
        
        const tutorialSection = this.elements.tutorialSection;
        if (tutorialSection) {
            if (this.state.tutorialMode) {
                tutorialSection.style.display = 'block';
                tutorialSection.classList.add('animate-fadeIn');
                this.loadTutorialStep(0);
            } else {
                tutorialSection.classList.add('animate-fadeOut');
                setTimeout(() => {
                    tutorialSection.style.display = 'none';
                    tutorialSection.classList.remove('animate-fadeOut');
                }, 400);
            }
        }
        
        console.log(`üéì Tutorial modu: ${this.state.tutorialMode ? 'a√ßƒ±k' : 'kapalƒ±'}`);
    }
    
    /**
     * Tutorial adƒ±mlarƒ±nƒ± y√∂netir
     */
    loadTutorialStep(stepIndex) {
        // Tutorial steps component'e y√∂nlendir
        if (this.uiComponents) {
            this.uiComponents.loadTutorialStep(stepIndex);
        }
    }
    
    nextTutorialStep() {
        if (this.state.currentStep < 4) {
            this.state.currentStep++;
            this.loadTutorialStep(this.state.currentStep);
        }
    }
    
    previousTutorialStep() {
        if (this.state.currentStep > 0) {
            this.state.currentStep--;
            this.loadTutorialStep(this.state.currentStep);
        }
    }
    
    /**
     * UI g√ºncellemeleri
     */
    updateUI() {
        this.updateGridInfo();
        this.updateCameraControls(this.isRunning);
        this.updateGridStatistics();
    }
    
    updateGridInfo() {
        if (this.elements.currentGridSize) {
            this.elements.currentGridSize.textContent = `${this.state.gridSize}x${this.state.gridSize}`;
        }
        
        if (this.elements.totalCells) {
            this.elements.totalCells.textContent = this.state.gridSize * this.state.gridSize;
        }
    }
    
    updateCameraControls(isRunning) {
        if (this.elements.startCamera) {
            this.elements.startCamera.disabled = isRunning;
        }
        
        if (this.elements.stopCamera) {
            this.elements.stopCamera.disabled = !isRunning;
        }
    }
    
    updateDetectionResults(detections) {
        const resultsList = this.elements.resultsList;
        if (!resultsList) return;
        
        if (detections.length === 0) {
            resultsList.innerHTML = '<div class="no-detections">Hen√ºz nesne tespit edilmedi</div>';
            return;
        }
        
        const resultsHTML = detections.map(detection => `
            <div class="detection-item">
                <span class="detection-name">${detection.class}</span>
                <span class="detection-confidence">${Math.round(detection.score * 100)}%</span>
            </div>
        `).join('');
        
        resultsList.innerHTML = resultsHTML;
    }
    
    updateGridStatistics() {
        const activeCells = this.gridManager ? this.gridManager.getActiveCellCount() : 0;
        
        if (this.elements.activeCells) {
            this.elements.activeCells.textContent = activeCells;
        }
        
        if (this.elements.detectionCount) {
            this.elements.detectionCount.textContent = this.state.detections.length;
        }
    }
    
    updatePerformanceMetrics(processTime) {
        const now = Date.now();
        const deltaTime = now - this.state.performance.lastUpdate;
        
        if (deltaTime > 0) {
            this.state.performance.fps = Math.round(1000 / deltaTime);
            this.state.performance.processTime = Math.round(processTime);
            this.state.performance.lastUpdate = now;
        }
    }
    
    /**
     * Utility methods
     */
    clearDetections() {
        this.state.detections = [];
        this.updateDetectionResults([]);
        this.updateGridStatistics();
        
        if (this.gridManager) {
            this.gridManager.clearDetections();
        }
    }
    
    showWelcomeAnimation() {
        // Header animasyonu
        const header = document.querySelector('.header');
        if (header) {
            header.classList.add('animate-fadeIn');
        }
        
        // Demo container animasyonu
        setTimeout(() => {
            const demoArea = document.querySelector('.demo-area');
            if (demoArea) {
                demoArea.classList.add('animate-slideInLeft');
            }
        }, 300);
    }
    
    showLoading(message = 'Y√ºkleniyor...') {
        // Loading g√∂stergesi implementasyonu
        console.log(`‚è≥ ${message}`);
    }
    
    hideLoading() {
        console.log('‚úÖ Y√ºkleme tamamlandƒ±');
    }
    
    showError(message) {
        console.error(`‚ùå Hata: ${message}`);
        // Toast notification veya modal g√∂sterilebilir
        alert(message);
    }
    
    /**
     * Cleanup - sayfa kapatƒ±lƒ±rken √ßaƒürƒ±lƒ±r
     */
    cleanup() {
        if (this.isRunning) {
            this.stopCamera();
        }
        
        // Event listener'larƒ± temizle
        this.eventListeners.forEach(({element, event, handler}) => {
            element.removeEventListener(event, handler);
        });
        
        console.log('üßπ Cleanup tamamlandƒ±');
    }
}

// Uygulama ba≈ülatma
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Global app instance
        window.yoloGridApp = new YOLOGridApp();
        await window.yoloGridApp.init();
        
    } catch (error) {
        console.error('üí• Uygulama ba≈ülatƒ±lamadƒ±:', error);
    }
});

// Export for modules
export { YOLOGridApp };